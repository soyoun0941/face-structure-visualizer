<!DOCTYPE html>
<html>
<head>
  <title>FaceMesh 구조 보기</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    canvas { margin-top: 10px; border-radius: 8px; }
    .error { color: red; margin-top: 20px; }
    .analysis-box {
      margin-top: 20px;
      padding: 15px;
      background-color: #f4f4f4;
      border-radius: 10px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    .interpretation {
      margin-top: 10px;
      font-style: italic;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>📸 내 얼굴 구조 시각화</h2>
  <canvas class="output_canvas" width="640" height="480"></canvas>
  <div class="error" id="errorMsg"></div>
  <div class="analysis-box" id="faceAnalysis" style="display:none">
    <h3>🔍 얼굴의 구조적 특징</h3>
    <ul id="analysisText"></ul>
    <div class="interpretation" id="analysisInterpretation"></div>
  </div>

  <script>
    const canvasElement = document.querySelector('.output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const errorMsg = document.getElementById('errorMsg');
    const faceAnalysis = document.getElementById('faceAnalysis');
    const analysisText = document.getElementById('analysisText');
    const analysisInterpretation = document.getElementById('analysisInterpretation');

    function calculateDistance(p1, p2) {
      return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }

    function classifyRelative(value, avg, tol = 0.012) {
      const diff = value - avg;
      if (Math.abs(diff) <= tol) return '평균 범위입니다';
      if (diff < -tol) return '평균보다 좁은 편입니다';
      return '평균보다 넓은 편입니다';
    }
    <li><strong>눈 사이 비율:</strong> ${(ratios.eyeDistance / ratios.horizontal).toFixed(3)} (${ratios.eyeComment})</li>


    function classifyFaceShape(ratio, jawWidthRatio) {
      if (jawWidthRatio < 0.8 && ratio < 1.2) return '계란형';
      if (jawWidthRatio > 0.9 && ratio < 1.2) return '둥근형';
      if (jawWidthRatio < 0.8 && ratio >= 1.2 && ratio < 1.35) return '타원형';
      if (ratio >= 1.35) return '긴형';
      return '기타형';
    }

    function calculateRatios(landmarks) {
      const chin = landmarks[152];
      const forehead = landmarks[10];
      const leftCheek = landmarks[234];
      const rightCheek = landmarks[454];
      const leftEyeInner = landmarks[133];
      const rightEyeInner = landmarks[362];
      const noseTop = landmarks[6];
      const noseBottom = landmarks[2];
      const mouthLeft = landmarks[61];
      const mouthRight = landmarks[291];
      const jawLeft = landmarks[234];
      const jawRight = landmarks[454];
      const eyeOuterLeft = landmarks[130];
      const eyeOuterRight = landmarks[359];

      const vertical = calculateDistance(chin, forehead);
      const horizontal = calculateDistance(leftCheek, rightCheek);
      const eyeDistance = calculateDistance(leftEyeInner, rightEyeInner);
      const noseLength = calculateDistance(noseTop, noseBottom);
      const mouthWidth = calculateDistance(mouthLeft, mouthRight);
      const jawWidth = calculateDistance(jawLeft, jawRight);
      const eyeTilt = Math.atan2(eyeOuterRight.y - eyeOuterLeft.y, eyeOuterRight.x - eyeOuterLeft.x) * 180 / Math.PI;

      const verticalToHorizontal = vertical / horizontal;
      const eyeRatio = eyeDistance / horizontal;
      const noseRatio = noseLength / vertical;
      const mouthRatio = mouthWidth / horizontal;
      const jawRatio = jawWidth / horizontal;

      return {
        vertical: vertical.toFixed(2),
        horizontal: horizontal.toFixed(2),
        verticalToHorizontal: verticalToHorizontal.toFixed(2),
        eyeDistance: eyeDistance.toFixed(2),
        noseLength: noseLength.toFixed(2),
        mouthWidth: mouthWidth.toFixed(2),
        jawWidth: jawWidth.toFixed(2),
        eyeTilt: eyeTilt.toFixed(2),
        shape: classifyFaceShape(verticalToHorizontal, jawRatio),
        eyeComment: classifyRelative(eyeRatio, 0.275),
        noseComment: classifyRelative(noseRatio, 0.25),
        mouthComment: classifyRelative(mouthRatio, 0.38),
        jawComment: classifyRelative(jawRatio, 0.85)
      };
    }

    const faceMesh = new FaceMesh({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    faceMesh.onResults(results => {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

      if (results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];
        const ratios = calculateRatios(landmarks);

        analysisText.innerHTML = `
          <li><strong>세로 길이:</strong> ${ratios.vertical}px</li>
          <li><strong>가로 길이:</strong> ${ratios.horizontal}px</li>
          <li><strong>세로:가로 비율:</strong> ${ratios.verticalToHorizontal}</li>
          <li><strong>눈 사이 거리:</strong> ${ratios.eyeDistance}px (${ratios.eyeComment})</li>
          <li><strong>코 길이:</strong> ${ratios.noseLength}px (${ratios.noseComment})</li>
          <li><strong>입꼬리 너비:</strong> ${ratios.mouthWidth}px (${ratios.mouthComment})</li>
          <li><strong>턱 너비:</strong> ${ratios.jawWidth}px (${ratios.jawComment})</li>
          <li><strong>눈꼬리 기울기:</strong> ${ratios.eyeTilt}°</li>
          <li><strong>추정 얼굴형:</strong> ${ratios.shape}</li>`;

        analysisInterpretation.innerHTML = `
          얼굴형은 <strong>${ratios.shape}</strong>이며,<br>
          눈 사이 간격은 ${ratios.eyeComment}, 코 길이는 ${ratios.noseComment},<br>
          입꼬리 너비는 ${ratios.mouthComment}, 턱 너비는 ${ratios.jawComment}입니다.`;

        faceAnalysis.style.display = 'block';
      }

      canvasCtx.restore();
    });

    async function setupCamera() {
      const videoElement = document.createElement('video');
      videoElement.style.display = 'none';
      document.body.appendChild(videoElement);

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoElement.srcObject = stream;
        return new Promise((resolve) => {
          videoElement.onloadedmetadata = () => resolve(videoElement);
        });
      } catch (err) {
        errorMsg.textContent = '🚫 카메라 접근이 거부되었습니다.';
        throw err;
      }
    }

    setupCamera().then(video => {
      new Camera(video, {
        onFrame: async () => await faceMesh.send({image: video}),
        width: 640,
        height: 480
      }).start();
    });
  </script>
</body>
</html>
