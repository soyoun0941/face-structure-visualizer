<!DOCTYPE html>
<html>
<head>
  <title>FaceMesh êµ¬ì¡° ë³´ê¸°</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    video, canvas { margin-top: 10px; border-radius: 8px; }
    .error { color: red; margin-top: 20px; }
    .analysis-box {
      margin-top: 20px;
      padding: 15px;
      background-color: #f4f4f4;
      border-radius: 10px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    .interpretation {
      margin-top: 10px;
      font-style: italic;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>ğŸ“¸ ë‚´ ì–¼êµ´ êµ¬ì¡° ì‹œê°í™”</h2>
  <video class="input_video" autoplay playsinline width="640" height="480"></video>
  <canvas class="output_canvas" width="640" height="480"></canvas>
  <div class="error" id="errorMsg"></div>
  <div class="analysis-box" id="faceAnalysis" style="display:none">
    <h3>ğŸ” ì–¼êµ´ì˜ êµ¬ì¡°ì  íŠ¹ì§•</h3>
    <ul id="analysisText"></ul>
    <div class="interpretation" id="analysisInterpretation"></div>
  </div>

  <script>
    const videoElement = document.getElementsByClassName('input_video')[0];
    const canvasElement = document.getElementsByClassName('output_canvas')[0];
    const canvasCtx = canvasElement.getContext('2d');
    const errorMsg = document.getElementById('errorMsg');
    const faceAnalysis = document.getElementById('faceAnalysis');
    const analysisText = document.getElementById('analysisText');
    const analysisInterpretation = document.getElementById('analysisInterpretation');

    function calculateDistance(p1, p2) {
      return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }

    function classifyFaceShape(ratios) {
      const r = parseFloat(ratios.verticalToHorizontal);
      if (r < 1.1) return "ë‘¥ê·¼í˜•";
      if (r < 1.3) return "íƒ€ì›í˜•";
      if (r < 1.5) return "ê³„ë€í˜•";
      return "ê¸´í˜•";
    }

    function classifyEyeSpacing(eyeDistance, faceWidth) {
      const ratio = eyeDistance / faceWidth;
      if (ratio < 0.25) return "ëˆˆ ì‚¬ì´ê°€ ê°€ê¹Œìš´ í¸";
      if (ratio < 0.35) return "ëˆˆ ì‚¬ì´ê°€ í‰ê· ";
      return "ëˆˆ ì‚¬ì´ê°€ ë„“ì€ í¸";
    }

    function classifyNoseLength(noseLength, faceHeight) {
      const ratio = noseLength / faceHeight;
      if (ratio < 0.22) return "ì½”ê°€ ì§§ì€ í¸";
      if (ratio < 0.28) return "ì½” ê¸¸ì´ê°€ í‰ê· ";
      return "ì½”ê°€ ê¸´ í¸";
    }

    function calculateRatios(landmarks) {
      const chin = landmarks[152];
      const forehead = landmarks[10];
      const leftCheek = landmarks[234];
      const rightCheek = landmarks[454];
      const leftEyeInner = landmarks[133];
      const rightEyeInner = landmarks[362];
      const noseTop = landmarks[6];
      const noseBottom = landmarks[2];

      const vertical = calculateDistance(chin, forehead);
      const horizontal = calculateDistance(leftCheek, rightCheek);
      const eyeDistance = calculateDistance(leftEyeInner, rightEyeInner);
      const noseLength = calculateDistance(noseTop, noseBottom);

      return {
        vertical: vertical.toFixed(2),
        horizontal: horizontal.toFixed(2),
        verticalToHorizontal: (vertical / horizontal).toFixed(2),
        eyeDistance: eyeDistance.toFixed(2),
        noseLength: noseLength.toFixed(2),
        shape: classifyFaceShape({ verticalToHorizontal: (vertical / horizontal).toFixed(2) }),
        eyeComment: classifyEyeSpacing(eyeDistance, horizontal),
        noseComment: classifyNoseLength(noseLength, vertical)
      };
    }

    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoElement.srcObject = stream;
        return new Promise((resolve) => {
          videoElement.onloadedmetadata = () => {
            resolve(videoElement);
          };
        });
      } catch (err) {
        errorMsg.textContent = 'ğŸš« ì¹´ë©”ë¼ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”. (HTTPS í™˜ê²½ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤)';
        throw err;
      }
    }

    const faceMesh = new FaceMesh({locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
    }});

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    faceMesh.onResults((results) => {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];
        const ratios = calculateRatios(landmarks);

        analysisText.innerHTML = `
          <li><strong>ì„¸ë¡œ ê¸¸ì´:</strong> ${ratios.vertical}px</li>
          <li><strong>ê°€ë¡œ ê¸¸ì´:</strong> ${ratios.horizontal}px</li>
          <li><strong>ì„¸ë¡œ:ê°€ë¡œ ë¹„ìœ¨:</strong> ${ratios.verticalToHorizontal} (1:${(1 / ratios.verticalToHorizontal).toFixed(2)})</li>
          <li><strong>ëˆˆ ì‚¬ì´ ê±°ë¦¬:</strong> ${ratios.eyeDistance}px</li>
          <li><strong>ì½” ê¸¸ì´:</strong> ${ratios.noseLength}px</li>
          <li><strong>ì¶”ì • ì–¼êµ´í˜•:</strong> ${ratios.shape}</li>`;

        analysisInterpretation.innerHTML = `
          ì–¼êµ´ì€ <strong>${ratios.shape}</strong>ì— ê°€ê¹Œìš°ë©°, ì„¸ë¡œ ëŒ€ë¹„ ê°€ë¡œ ë¹„ìœ¨ì´ ${ratios.verticalToHorizontal}ë¡œ<br>
          ${ratios.eyeComment}ì´ê³  ${ratios.noseComment}ìœ¼ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.`;

        faceAnalysis.style.display = 'block';
      }
      canvasCtx.restore();
    });

    setupCamera().then(() => {
      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await faceMesh.send({image: videoElement});
        },
        width: 640,
        height: 480
      });
      camera.start();
    }).catch((e) => {
      console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:', e);
    });
  </script>
</body>
</html>