<!DOCTYPE html>
<html>
<head>
  <title>FaceMesh 구조 보기</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    video, canvas { margin-top: 10px; border-radius: 8px; }
    .error { color: red; margin-top: 20px; }
    .analysis-box {
      margin-top: 20px;
      padding: 15px;
      background-color: #f4f4f4;
      border-radius: 10px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    .interpretation {
      margin-top: 10px;
      font-style: italic;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>📸 내 얼굴 구조 시각화</h2>
  <video class="input_video" autoplay playsinline width="640" height="480"></video>
  <canvas class="output_canvas" width="640" height="480"></canvas>
  <div class="error" id="errorMsg"></div>
  <div class="analysis-box" id="faceAnalysis" style="display:none">
    <h3>🔍 얼굴의 구조적 특징</h3>
    <ul id="analysisText"></ul>
    <div class="interpretation" id="analysisInterpretation"></div>
  </div>

  <script>
    const videoElement = document.getElementsByClassName('input_video')[0];
    const canvasElement = document.getElementsByClassName('output_canvas')[0];
    const canvasCtx = canvasElement.getContext('2d');
    const errorMsg = document.getElementById('errorMsg');
    const faceAnalysis = document.getElementById('faceAnalysis');
    const analysisText = document.getElementById('analysisText');
    const analysisInterpretation = document.getElementById('analysisInterpretation');

    function calculateDistance(p1, p2) {
      return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }

    function classifyFaceShape(ratios) {
      const r = parseFloat(ratios.verticalToHorizontal);
      if (r < 1.1) return "둥근형";
      if (r < 1.3) return "타원형";
      if (r < 1.5) return "계란형";
      return "긴형";
    }

    function classifyEyeSpacing(eyeDistance, faceWidth) {
      const ratio = eyeDistance / faceWidth;
      if (ratio < 0.25) return "눈 사이가 가까운 편";
      if (ratio < 0.35) return "눈 사이가 평균";
      return "눈 사이가 넓은 편";
    }

    function classifyNoseLength(noseLength, faceHeight) {
      const ratio = noseLength / faceHeight;
      if (ratio < 0.22) return "코가 짧은 편";
      if (ratio < 0.28) return "코 길이가 평균";
      return "코가 긴 편";
    }

    function calculateRatios(landmarks) {
      const chin = landmarks[152];
      const forehead = landmarks[10];
      const leftCheek = landmarks[234];
      const rightCheek = landmarks[454];
      const leftEyeInner = landmarks[133];
      const rightEyeInner = landmarks[362];
      const noseTop = landmarks[6];
      const noseBottom = landmarks[2];

      const vertical = calculateDistance(chin, forehead);
      const horizontal = calculateDistance(leftCheek, rightCheek);
      const eyeDistance = calculateDistance(leftEyeInner, rightEyeInner);
      const noseLength = calculateDistance(noseTop, noseBottom);

      return {
        vertical: vertical.toFixed(2),
        horizontal: horizontal.toFixed(2),
        verticalToHorizontal: (vertical / horizontal).toFixed(2),
        eyeDistance: eyeDistance.toFixed(2),
        noseLength: noseLength.toFixed(2),
        shape: classifyFaceShape({ verticalToHorizontal: (vertical / horizontal).toFixed(2) }),
        eyeComment: classifyEyeSpacing(eyeDistance, horizontal),
        noseComment: classifyNoseLength(noseLength, vertical)
      };
    }

    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoElement.srcObject = stream;
        return new Promise((resolve) => {
          videoElement.onloadedmetadata = () => {
            resolve(videoElement);
          };
        });
      } catch (err) {
        errorMsg.textContent = '🚫 카메라 접근이 거부되었습니다. 브라우저 설정에서 권한을 허용해주세요. (HTTPS 환경에서만 작동합니다)';
        throw err;
      }
    }

    const faceMesh = new FaceMesh({locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
    }});

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    faceMesh.onResults((results) => {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];
        const ratios = calculateRatios(landmarks);

        analysisText.innerHTML = `
          <li><strong>세로 길이:</strong> ${ratios.vertical}px</li>
          <li><strong>가로 길이:</strong> ${ratios.horizontal}px</li>
          <li><strong>세로:가로 비율:</strong> ${ratios.verticalToHorizontal} (1:${(1 / ratios.verticalToHorizontal).toFixed(2)})</li>
          <li><strong>눈 사이 거리:</strong> ${ratios.eyeDistance}px</li>
          <li><strong>코 길이:</strong> ${ratios.noseLength}px</li>
          <li><strong>추정 얼굴형:</strong> ${ratios.shape}</li>`;

        analysisInterpretation.innerHTML = `
          얼굴은 <strong>${ratios.shape}</strong>에 가까우며, 세로 대비 가로 비율이 ${ratios.verticalToHorizontal}로<br>
          ${ratios.eyeComment}이고 ${ratios.noseComment}으로 분석됩니다.`;

        faceAnalysis.style.display = 'block';
      }
      canvasCtx.restore();
    });

    setupCamera().then(() => {
      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await faceMesh.send({image: videoElement});
        },
        width: 640,
        height: 480
      });
      camera.start();
    }).catch((e) => {
      console.error('카메라 접근 오류:', e);
    });
  </script>
</body>
</html>